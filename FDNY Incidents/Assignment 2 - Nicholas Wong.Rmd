---
title: "Untitled"
author: "Nicholas Wong"
date: "March 25, 2018"
output:
  html_document:
    keep_md: true
---

```{r Setup, include=FALSE, results='hide', warning=FALSE}
library(knitr)
opts_chunk$set(fig.path="images/",
               cache.path="cache/",
               cache=FALSE,
               echo=TRUE,
               message=FALSE,
               warning=FALSE)  
```

```{r, echo=FALSE, message = FALSE, warning = FALSE}
library(readr)
library(leaflet)
library(leaflet.extras)
library(dplyr)
library(tidyr)
library(RColorBrewer)
library(lubridate)
library(ggplot2)
library(ggthemes)
library(RANN)
```

```{r, echo=FALSE, message = FALSE}
incidents <- read.csv("severe_incidents.csv")
firehouses <- read.csv("FDNY_Firehouse_Listing.csv")
```

#1. Location of Severe Fires

In the leaflet map below I have provided the location of severe incidents within New York City. In the pop-up information, you can see details about the incident, date, time and duration.

```{r, echo=FALSE, message = FALSE, warning = FALSE} 
incidents$INCIDENT_TYPE_DESC_2 <- gsub('\\d+ - ', '', incidents$INCIDENT_TYPE_DESC)
details <- paste("Incident:",incidents$INCIDENT_TYPE_DESC_2,"<br/>",
                 "Date:",gsub('(\\d+/\\d+/\\d+).*$','\\1', incidents$INCIDENT_DATE_TIME),"<br/>",
                 "Time:", gsub('(\\d+/\\d+/\\d+)','', incidents$INCIDENT_DATE_TIME),"<br/>",
                 "Duration:",incidents$TOTAL_INCIDENT_DURATION %/% 3600, "h ",
                 (incidents$TOTAL_INCIDENT_DURATION %% 3600) %/% 60, "m  ",
                 (incidents$TOTAL_INCIDENT_DURATION %% 3600) %% 60, "s", "<br/>")

leaf <- leaflet(incidents) %>%
  addProviderTiles(providers$Stamen.TonerLite) %>%
  addCircles(col='orange',lng = incidents$Longitude, lat = incidents$Latitude, popup = details ) %>%
  setView(-74.0060, 40.7128, zoom = 11) 
leaf  
```


# 2. Layers and Clusters

## a) Color by Type of Property

In the leaflet map below I have provided details about the type of property that was affected in each incident, including its general type (e.g. 'commercial', 'residential') and specific use (e.g. 'multilevel residence').

```{r, echo=FALSE, message = FALSE, warning = FALSE}
#Question 2a
incidents$PROPERTY_USE_DESC_2 <- as.numeric(gsub("([0-9]+).*$", "\\1", incidents$PROPERTY_USE_DESC)) %/% 100
incidents$PROPERTY_USE_DESC_2 <- factor(incidents$PROPERTY_USE_DESC_2, labels = c("Other", "Entertainment", "Education", "Public Services", "Residential", "Commercial", "Infrastructure", "Industrial", "Storage", "Open Space"))

palette = colorFactor("Set1", domain = incidents$PROPERTY_USE_DESC_2) 
propertyuse_col = palette(incidents$PROPERTY_USE_DESC_2)

details2 <- paste("Property Type:", incidents$PROPERTY_USE_DESC_2,"<br/>",
                 "Property Use:",gsub('\\d+ - ', '', incidents$PROPERTY_USE_DESC),"<br/>")

leaf2 <- leaflet(incidents) %>%
  addProviderTiles(providers$Stamen.TonerLite) %>%
  addCircles(color = propertyuse_col, popup = details2 ) %>%
  setView(-74.0060, 40.7128, zoom = 11) %>%
  addLegend(pal = palette, values = ~incidents$PROPERTY_USE_DESC_2, title = "Property Use")
leaf2
```


## b) Cluster

Marker clustering has been added in the leaflet map below.

```{r, echo=FALSE, message = FALSE, warning = FALSE}
leaf2b <- leaflet(incidents) %>%
  addProviderTiles(providers$Stamen.TonerLite) %>%
  addCircleMarkers(col='orange',lng = incidents$Longitude, 
             lat = incidents$Latitude, popup = details2, 
             clusterOptions = markerClusterOptions()) %>%
  setView(-74.0060, 40.7128, zoom = 11) 
leaf2b
```


# 3. Fire Houses

The map below represents the severity of the incidents using the number of units on scene as a proxy. The larger the radius, the more severe the incident.The color-coding from the previous question has been retained to show the type of property that was affected in each incident.

```{r, echo=FALSE, message = FALSE, warning = FALSE}
details3 <- paste("Property Type:",incidents$PROPERTY_USE_DESC_2,"<br/>",
                   "Property Use:",gsub('\\d+ - ', '', incidents$PROPERTY_USE_DESC),"<br/>",
                   "Severity:", incidents$UNITS_ONSCENE," units on scene","<br/>")

leaf3 <- leaflet(incidents) %>%
  addProviderTiles(providers$Stamen.TonerLite) %>%
  addCircleMarkers(group = "Incidents", color = propertyuse_col, 
                   popup = details3, radius = incidents$UNITS_ONSCENE ) %>%
  setView(-74.0060, 40.7128, zoom = 13) %>%
  addCircles(group = "Firehouses", color = 'black', data=firehouses) %>%
  addLegend(pal = palette, values = ~incidents$PROPERTY_USE_DESC_2, title = "Property Use") %>%
  addLayersControl(
    overlayGroups = c("Fire houses", "Incidents"),
    options = layersControlOptions(collapsed = TRUE) )
leaf3
```

# 4. Distance from Firehouse and Response Time

## a) Calculate Distance

I used the 'fast nearest neighbor search' package to find the nearest firehouse relative to each incident, and then plotted it in a scatterplot using ggplot.

```{r, echo=FALSE, message = FALSE, warning = FALSE}
incidents <- incidents %>% drop_na(c('Latitude', 'Longitude'))
incident_loc <- incidents[c('Latitude', 'Longitude')] 
firehouses <- firehouses %>% drop_na(c('Latitude', 'Longitude'))
firehouse_loc <- firehouses[c('Latitude', 'Longitude')] 

nearest_fh <- nn2(firehouse_loc, query=incident_loc, k=1)$nn.dists
incidents$nearest_fh <- as.numeric(nearest_fh)
incidents$Borough <- as.factor(incidents$BOROUGH_DESC)

incidents$incident_time <- parse_date_time(incidents$INCIDENT_DATE_TIME, c('%m/%d/%Y %I:%M:%S %p'), exact = TRUE)
incidents$arriv_time <- parse_date_time(incidents$ARRIVAL_DATE_TIME, c('%m/%d/%Y %I:%M:%S %p'), exact = TRUE)
incidents$response_time <- as.numeric(as.duration(incidents$incident_time %--% incidents$arriv_time))
incidents_scatter <- incidents[c('nearest_fh', 'response_time')]

plot <- ggplot(incidents %>% filter(nearest_fh < 0.03) %>% 
                filter(response_time <700), aes(x=nearest_fh, y=response_time)) +
  geom_point(aes(color=Borough)) + geom_smooth(color = 'red') + 
  labs(x="Distance from Nearest Firehouse",
       y="Response Time (Minutes)",
       title="Plot of Response Time vs Distance from Nearest Firehouse") +
  theme_bw()
plot

```

## b) Map of Response Times

The heatmap below shows the response times (determined by time until the arrival of the first unit on the scene). The color intensity of the heat map corresponds to the response time. Furthermore, the popup information shows the incident type and response time for each incident location.

```{r, echo=FALSE, message = FALSE, warning = FALSE}
details4 <- paste("Incident: ",incidents$INCIDENT_TYPE_DESC_2,"<br/>",
  "Response Time: ", incidents$response_time)

leaf4 <- leaflet(incidents) %>% addProviderTiles(providers$Stamen.TonerLite) %>%
  setView(-74.0060, 40.7128, zoom = 10) %>%
  addCircles(group = "Incidents", color = gray, 
                   popup = details4) %>%
  addCircles(group = "Firehouses", color = 'black', data=firehouses) %>%
  addHeatmap(lng = ~Longitude, lat = ~Latitude, intensity = ~response_time,
             blur = 20, max = 0.5, radius = 15)

leaf4
```

